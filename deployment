# ROSAGO DEPLOYMENT PLAYBOOK
# ===========================
# This file defines the complete deployment process for ROSAgo.
# When user says "deploy" or "prepare for production", read this file and execute.

## APPROVED PRODUCTION STACK
## =========================

| Component | Service | URL Pattern |
|-----------|---------|-------------|
| Backend API | Render Web Service | https://api.rosago.com |
| Admin Dashboard | Vercel | https://admin.rosago.com |
| Mobile App | Expo EAS | App Store / Play Store |
| Database | Render PostgreSQL | Internal connection |
| Redis | Render Redis | Internal connection |
| Images | Cloudinary | CDN URLs |
| Maps | Maptiler | Already integrated |
| Payments | Hubtel | Ghana MoMo |
| Errors | Sentry | Dashboard |
| Email | Resend | Transactional |

---

## ENVIRONMENT VARIABLES
## =====================

### Backend (.env.production)
```
# Server
NODE_ENV=production
PORT=3000

# Database (Render provides this)
DATABASE_URL=postgresql://user:password@host:5432/rosago_prod

# Redis (Render provides this)
REDIS_URL=redis://user:password@host:6379

# JWT
JWT_SECRET=<generate-strong-secret-64-chars>
JWT_EXPIRES_IN=30m
JWT_REFRESH_EXPIRES_IN=7d

# Hubtel Payments
HUBTEL_API_KEY=<your-hubtel-api-key>
HUBTEL_WEBHOOK_SECRET=<your-hubtel-webhook-secret>
HUBTEL_MERCHANT_ID=<your-merchant-id>

# Maptiler
MAPTILER_API_KEY=<your-maptiler-key>

# Cloudinary
CLOUDINARY_URL=cloudinary://api_key:api_secret@cloud_name

# Sentry
SENTRY_DSN=<your-sentry-dsn>

# Resend Email
RESEND_API_KEY=<your-resend-key>

# App URLs
ADMIN_URL=https://admin.rosago.com
MOBILE_DEEP_LINK=rosago://
```

### Admin Web (.env.production)
```
NEXT_PUBLIC_API_URL=https://api.rosago.com
NEXT_PUBLIC_WS_URL=wss://api.rosago.com
NEXT_PUBLIC_MAPTILER_KEY=<your-maptiler-key>
NEXT_PUBLIC_SENTRY_DSN=<your-sentry-dsn>
```

### Mobile App (app.config.js production)
```
API_URL=https://api.rosago.com
WS_URL=wss://api.rosago.com
MAPTILER_KEY=<your-maptiler-key>
SENTRY_DSN=<your-sentry-dsn>
```

---

## DEPLOYMENT FILES TO CREATE
## ==========================

### 1. Backend Dockerfile (backend/Dockerfile)
```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./
COPY prisma ./prisma/

# Install dependencies
RUN npm ci --only=production

# Copy source
COPY . .

# Generate Prisma client
RUN npx prisma generate

# Build
RUN npm run build

# Production image
FROM node:18-alpine AS runner

WORKDIR /app

# Copy built assets
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/prisma ./prisma

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1

# Start command
CMD ["node", "dist/src/main.js"]
```

### 2. Backend render.yaml (backend/render.yaml)
```yaml
services:
  - type: web
    name: rosago-api
    env: node
    region: frankfurt  # Closest to Ghana
    plan: starter
    buildCommand: npm ci && npx prisma generate && npm run build
    startCommand: npx prisma migrate deploy && node dist/src/main.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: rosago-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: rosago-redis
          type: redis
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: 30m
      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d

databases:
  - name: rosago-db
    databaseName: rosago_prod
    plan: starter
    region: frankfurt

services:
  - type: redis
    name: rosago-redis
    plan: starter
    region: frankfurt
    maxmemoryPolicy: allkeys-lru
```

### 3. Admin vercel.json (admin-web/vercel.json)
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/$1"
    }
  ],
  "env": {
    "NEXT_PUBLIC_API_URL": "@api_url",
    "NEXT_PUBLIC_WS_URL": "@ws_url"
  }
}
```

### 4. Mobile eas.json (frontend/eas.json)
```json
{
  "cli": {
    "version": ">= 5.0.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal",
      "ios": {
        "simulator": true
      }
    },
    "preview": {
      "distribution": "internal",
      "ios": {
        "simulator": false
      },
      "android": {
        "buildType": "apk"
      }
    },
    "production": {
      "distribution": "store",
      "ios": {
        "resourceClass": "m-medium"
      },
      "android": {
        "buildType": "app-bundle"
      }
    }
  },
  "submit": {
    "production": {
      "ios": {
        "appleId": "your-apple-id@email.com",
        "ascAppId": "your-app-store-connect-app-id",
        "appleTeamId": "your-team-id"
      },
      "android": {
        "serviceAccountKeyPath": "./google-services.json",
        "track": "internal"
      }
    }
  }
}
```

### 5. GitHub Actions CI/CD (.github/workflows/deploy.yml)
```yaml
name: Deploy ROSAgo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Backend Dependencies
        run: cd backend && npm ci
      - name: Run Backend Tests
        run: cd backend && npm test
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Render
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}

  deploy-admin:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./admin-web

  build-mobile:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Install Dependencies
        run: cd frontend && npm ci
      - name: Build for Production
        run: cd frontend && eas build --platform all --non-interactive --profile production
```

---

## DEPLOYMENT STEPS
## ================

### Phase 1: Setup Services (One-time)

#### Step 1.1: Create Render Account & Services
1. Go to render.com and sign up
2. Create new PostgreSQL database (rosago-db)
3. Create new Redis instance (rosago-redis)
4. Create new Web Service (rosago-api)
   - Connect GitHub repo
   - Set root directory: backend
   - Set build command: npm ci && npx prisma generate && npm run build
   - Set start command: npx prisma migrate deploy && node dist/src/main.js

#### Step 1.2: Create Vercel Account & Project
1. Go to vercel.com and sign up
2. Import GitHub repo
3. Set root directory: admin-web
4. Set framework: Next.js
5. Add environment variables

#### Step 1.3: Create Expo Account & Project
1. Go to expo.dev and sign up
2. Run: cd frontend && eas init
3. Run: eas build:configure
4. Set up Apple Developer account (for iOS)
5. Set up Google Play Console (for Android)

#### Step 1.4: Create Supporting Services
1. Cloudinary: cloudinary.com - Get API credentials
2. Sentry: sentry.io - Create project, get DSN
3. Resend: resend.com - Get API key
4. Hubtel: developers.hubtel.com - Get API credentials

### Phase 2: Configure Environment Variables

#### Render (Backend)
```
DATABASE_URL → Auto from Render PostgreSQL
REDIS_URL → Auto from Render Redis
JWT_SECRET → Generate: openssl rand -base64 64
JWT_EXPIRES_IN → 30m
JWT_REFRESH_EXPIRES_IN → 7d
HUBTEL_API_KEY → From Hubtel dashboard
HUBTEL_WEBHOOK_SECRET → From Hubtel dashboard
MAPTILER_API_KEY → From Maptiler dashboard
CLOUDINARY_URL → From Cloudinary dashboard
SENTRY_DSN → From Sentry dashboard
RESEND_API_KEY → From Resend dashboard
```

#### Vercel (Admin)
```
NEXT_PUBLIC_API_URL → https://rosago-api.onrender.com (or custom domain)
NEXT_PUBLIC_WS_URL → wss://rosago-api.onrender.com
NEXT_PUBLIC_MAPTILER_KEY → From Maptiler dashboard
```

#### Expo (Mobile)
Update app.config.js with production values

### Phase 3: Deploy

#### Step 3.1: Deploy Backend
```bash
git add .
git commit -m "Deploy: Backend production ready"
git push origin main
# Render auto-deploys from main branch
```

#### Step 3.2: Deploy Admin Dashboard
```bash
# Vercel auto-deploys from main branch
# Or manually: cd admin-web && vercel --prod
```

#### Step 3.3: Build Mobile Apps
```bash
cd frontend

# Build for iOS
eas build --platform ios --profile production

# Build for Android
eas build --platform android --profile production

# Submit to stores
eas submit --platform ios
eas submit --platform android
```

### Phase 4: Post-Deployment

#### Step 4.1: Run Database Migrations
```bash
# Render runs migrations on deploy via start command
# Or manually via Render shell:
npx prisma migrate deploy
```

#### Step 4.2: Seed Production Data
```bash
# Via Render shell:
npm run seed:prod
```

#### Step 4.3: Verify Deployment
```bash
# Health check
curl https://api.rosago.com/health

# Test login
curl -X POST https://api.rosago.com/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"platform@saferide.com","password":"Test@1234"}'
```

#### Step 4.4: Setup Monitoring
1. Check Sentry for errors
2. Monitor Render metrics
3. Set up uptime monitoring (e.g., UptimeRobot)

---

## CUSTOM DOMAINS (Optional)
## =========================

### Backend (api.rosago.com)
1. In Render dashboard, go to rosago-api service
2. Settings → Custom Domains
3. Add api.rosago.com
4. Add DNS CNAME record: api → rosago-api.onrender.com

### Admin (admin.rosago.com)
1. In Vercel dashboard, go to project settings
2. Domains → Add domain
3. Add admin.rosago.com
4. Add DNS CNAME record: admin → cname.vercel-dns.com

---

## ROLLBACK PROCEDURES
## ===================

### Backend Rollback
```bash
# In Render dashboard:
# 1. Go to rosago-api service
# 2. Click "Manual Deploy"
# 3. Select previous commit
# Or via CLI:
git revert HEAD
git push origin main
```

### Admin Rollback
```bash
# In Vercel dashboard:
# 1. Go to Deployments
# 2. Find previous deployment
# 3. Click "..." → Promote to Production
```

### Database Rollback
```bash
# Via Render shell:
npx prisma migrate resolve --rolled-back <migration_name>
# Then re-deploy with fixed migration
```

---

## SCALING GUIDE
## =============

### When to Scale

| Metric | Threshold | Action |
|--------|-----------|--------|
| Response time p95 | > 500ms | Scale up backend |
| Memory usage | > 80% | Increase instance size |
| CPU usage | > 70% sustained | Add instances |
| DB connections | > 80% pool | Upgrade DB plan |
| Redis memory | > 80% | Upgrade Redis plan |

### How to Scale on Render

1. Go to service settings
2. Change plan from Starter to Standard/Pro
3. For horizontal scaling, use Render's autoscaling (Pro plan)

---

## SECURITY CHECKLIST
## ==================

### Before Launch
- [ ] All secrets in environment variables (not in code)
- [ ] JWT secret is strong (64+ characters)
- [ ] HTTPS only (Render provides this)
- [ ] CORS configured for production domains
- [ ] Rate limiting enabled
- [ ] SQL injection protection (Prisma handles this)
- [ ] XSS protection headers
- [ ] Sensitive data not logged

### Hubtel Webhook Security
- [ ] Webhook signature validation enabled
- [ ] Webhook endpoint only accepts POST
- [ ] IP whitelist if Hubtel provides IPs

---

## MONITORING & ALERTS
## ===================

### Sentry Alerts
1. Error rate > 1% → Email alert
2. New error type → Slack notification
3. Performance degradation → Dashboard alert

### Uptime Monitoring
1. Set up UptimeRobot or Better Uptime
2. Monitor: https://api.rosago.com/health
3. Alert channels: Email, SMS

### Render Metrics
1. CPU usage
2. Memory usage
3. Request count
4. Response times

---

## COST ESTIMATION
## ===============

### Launch Phase (0-1000 users)
| Service | Plan | Monthly Cost |
|---------|------|--------------|
| Render Backend | Starter | $7 |
| Render PostgreSQL | Starter | $7 |
| Render Redis | Starter | $7 |
| Vercel | Hobby | $0 |
| Expo EAS | Free | $0 |
| Cloudinary | Free | $0 |
| Sentry | Free | $0 |
| Resend | Free | $0 |
| **TOTAL** | | **$21/month** |

### Growth Phase (1000-10000 users)
Estimate: $200-400/month

---

## AI EXECUTION NOTES
## ==================

When user says "deploy":
1. Read this entire file
2. Check all deployment files exist
3. Create missing files
4. Guide user through service setup
5. Verify environment variables are set
6. Execute deployment commands
7. Run post-deployment verification
8. Report deployment status

When user says "rollback":
1. Identify which service to rollback
2. Execute appropriate rollback procedure
3. Verify service is healthy
4. Report rollback status
